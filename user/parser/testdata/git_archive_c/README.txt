This code was taken from here: https://github.com/git/git/blob/master/archive.c,
and was modified by removing the UNUSED macro, which isn't supported.